/*!
 * Name: tinyjs-plugin-particles
 * Description: A really fast type of the Container built solely for speed
 * Author: yiiqii
 * Version: v0.4.0
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t.Tiny=t.Tiny||{},t.Tiny.particles={}))}(this,function(t){"use strict";var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),r=function t(e,i,r){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,i);if(void 0===n){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,i,r)}if("value"in n)return n.value;var o=n.get;return void 0!==o?o.call(r):void 0},n=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},a=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},o=function(t){function o(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1500,i=arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16384,n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];e(this,o);var s=a(this,(o.__proto__||Object.getPrototypeOf(o)).call(this));return r>16384&&(r=16384),r>t&&(r=t),s._properties=[!1,!0,!1,!1,!1],s._maxSize=t,s._batchSize=r,s._glBuffers={},s._bufferUpdateIDs=[],s._updateID=0,s.interactiveChildren=!1,s.blendMode=Tiny.BLEND_MODES.NORMAL,s.autoResize=n,s.roundPixels=!0,s.baseTexture=null,s.setProperties(i),s._tint=0,s.tintRgb=new Float32Array(4),s.tint=16777215,s}return n(o,t),i(o,[{key:"setProperties",value:function(t){t&&(this._properties[0]="vertices"in t||"scale"in t?!!t.vertices||!!t.scale:this._properties[0],this._properties[1]="position"in t?!!t.position:this._properties[1],this._properties[2]="rotation"in t?!!t.rotation:this._properties[2],this._properties[3]="uvs"in t?!!t.uvs:this._properties[3],this._properties[4]="tint"in t||"alpha"in t?!!t.tint||!!t.alpha:this._properties[4])}},{key:"updateTransform",value:function(){this.displayObjectUpdateTransform()}},{key:"renderWebGL",value:function(t){var e=this;this.visible&&!(this.worldAlpha<=0)&&this.children.length&&this.renderable&&(this.baseTexture||(this.baseTexture=this.children[0]._texture.baseTexture,this.baseTexture.hasLoaded||this.baseTexture.once("update",function(){return e.onChildrenChange(0)})),t.setObjectRenderer(t.plugins.particle),t.plugins.particle.render(this))}},{key:"onChildrenChange",value:function(t){for(var e=Math.floor(t/this._batchSize);this._bufferUpdateIDs.length<e;)this._bufferUpdateIDs.push(0);this._bufferUpdateIDs[e]=++this._updateID}},{key:"renderCanvas",value:function(t){if(this.visible&&!(this.worldAlpha<=0)&&this.children.length&&this.renderable){var e=t.context,i=this.worldTransform,r=!0,n=0,a=0,o=0,s=0;t.setBlendMode(this.blendMode),e.globalAlpha=this.worldAlpha,this.displayObjectUpdateTransform();for(var u=0;u<this.children.length;++u){var h=this.children[u];if(h.visible){var l=h._texture.frame;if(e.globalAlpha=this.worldAlpha*h.alpha,h.rotation%(2*Math.PI)==0)r&&(e.setTransform(i.a,i.b,i.c,i.d,i.tx*t.resolution,i.ty*t.resolution),r=!1),n=h.anchor.x*(-l.width*h.scale.x)+h.position.x+.5,a=h.anchor.y*(-l.height*h.scale.y)+h.position.y+.5,o=l.width*h.scale.x,s=l.height*h.scale.y;else{r||(r=!0),h.displayObjectUpdateTransform();var d=h.worldTransform;t.roundPixels?e.setTransform(d.a,d.b,d.c,d.d,d.tx*t.resolution|0,d.ty*t.resolution|0):e.setTransform(d.a,d.b,d.c,d.d,d.tx*t.resolution,d.ty*t.resolution),n=h.anchor.x*-l.width+.5,a=h.anchor.y*-l.height+.5,o=l.width,s=l.height}var f=h._texture.baseTexture.resolution,c=h._texture.baseTexture.source;navigator.isAppXCanvasPlus&&"IMAGE"===c.tagName&&(c=navigator.canUseBinding?c.$realImage:c.src),e.drawImage(c,l.x*f,l.y*f,l.width*f,l.height*f,n*t.resolution,a*t.resolution,o*t.resolution,s*t.resolution)}}}}},{key:"destroy",value:function(t){if(r(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"destroy",this).call(this,t),this._buffers)for(var e=0;e<this._buffers.length;++e)this._buffers[e].destroy();this._properties=null,this._buffers=null,this._bufferUpdateIDs=null}},{key:"tint",get:function(){return this._tint},set:function(t){this._tint=t,Tiny.hex2rgb(t,this.tintRgb)}}]),o}(Tiny.Container),s=function(t){function i(t){return e(this,i),a(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,"attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aColor;\n\nattribute vec2 aPositionCoord;\nattribute float aRotation;\n\nuniform mat3 projectionMatrix;\nuniform vec4 uColor;\n\nvarying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nvoid main(void){\n    float x = (aVertexPosition.x) * cos(aRotation) - (aVertexPosition.y) * sin(aRotation);\n    float y = (aVertexPosition.x) * sin(aRotation) + (aVertexPosition.y) * cos(aRotation);\n\n    vec2 v = vec2(x, y);\n    v = v + aPositionCoord;\n\n    gl_Position = vec4((projectionMatrix * vec3(v, 1.0)).xy, 0.0, 1.0);\n\n    vTextureCoord = aTextureCoord;\n    vColor = aColor * uColor;\n}","varying vec2 vTextureCoord;\nvarying vec4 vColor;\n\nuniform sampler2D uSampler;\n\nvoid main(void){\n  vec4 color = texture2D(uSampler, vTextureCoord) * vColor;\n  gl_FragColor = color;\n}"))}return n(i,t),i}(Tiny.Shader);var u=function(){function t(i,r,n,a){e(this,t),this.gl=i,this.size=a,this.dynamicProperties=[],this.staticProperties=[];for(var o=0;o<r.length;++o){var s=r[o];s={attribute:s.attribute,size:s.size,uploadFunction:s.uploadFunction,unsignedByte:s.unsignedByte,offset:s.offset},n[o]?this.dynamicProperties.push(s):this.staticProperties.push(s)}this.staticStride=0,this.staticBuffer=null,this.staticData=null,this.staticDataUint32=null,this.dynamicStride=0,this.dynamicBuffer=null,this.dynamicData=null,this.dynamicDataUint32=null,this._updateID=0,this.initBuffers()}return i(t,[{key:"initBuffers",value:function(){var t=this.gl,e=0;this.indices=function(t){for(var e=6*t,i=new Uint16Array(e),r=0,n=0;r<e;r+=6,n+=4)i[r+0]=n+0,i[r+1]=n+1,i[r+2]=n+2,i[r+3]=n+0,i[r+4]=n+2,i[r+5]=n+3;return i}(this.size),this.indexBuffer=Tiny.glCore.GLBuffer.createIndexBuffer(t,this.indices,t.STATIC_DRAW),this.dynamicStride=0;for(var i=0;i<this.dynamicProperties.length;++i){var r=this.dynamicProperties[i];r.offset=e,e+=r.size,this.dynamicStride+=r.size}var n=new ArrayBuffer(this.size*this.dynamicStride*4*4);this.dynamicData=new Float32Array(n),this.dynamicDataUint32=new Uint32Array(n),this.dynamicBuffer=Tiny.glCore.GLBuffer.createVertexBuffer(t,n,t.STREAM_DRAW);var a=0;this.staticStride=0;for(var o=0;o<this.staticProperties.length;++o){var s=this.staticProperties[o];s.offset=a,a+=s.size,this.staticStride+=s.size}var u=new ArrayBuffer(this.size*this.staticStride*4*4);this.staticData=new Float32Array(u),this.staticDataUint32=new Uint32Array(u),this.staticBuffer=Tiny.glCore.GLBuffer.createVertexBuffer(t,u,t.STATIC_DRAW),this.vao=new Tiny.glCore.VertexArrayObject(t).addIndex(this.indexBuffer);for(var h=0;h<this.dynamicProperties.length;++h){var l=this.dynamicProperties[h];l.unsignedByte?this.vao.addAttribute(this.dynamicBuffer,l.attribute,t.UNSIGNED_BYTE,!0,4*this.dynamicStride,4*l.offset):this.vao.addAttribute(this.dynamicBuffer,l.attribute,t.FLOAT,!1,4*this.dynamicStride,4*l.offset)}for(var d=0;d<this.staticProperties.length;++d){var f=this.staticProperties[d];f.unsignedByte?this.vao.addAttribute(this.staticBuffer,f.attribute,t.UNSIGNED_BYTE,!0,4*this.staticStride,4*f.offset):this.vao.addAttribute(this.staticBuffer,f.attribute,t.FLOAT,!1,4*this.staticStride,4*f.offset)}}},{key:"uploadDynamic",value:function(t,e,i){for(var r=0;r<this.dynamicProperties.length;r++){var n=this.dynamicProperties[r];n.uploadFunction(t,e,i,n.unsignedByte?this.dynamicDataUint32:this.dynamicData,this.dynamicStride,n.offset)}this.dynamicBuffer.upload()}},{key:"uploadStatic",value:function(t,e,i){for(var r=0;r<this.staticProperties.length;r++){var n=this.staticProperties[r];n.uploadFunction(t,e,i,n.unsignedByte?this.staticDataUint32:this.staticData,this.staticStride,n.offset)}this.staticBuffer.upload()}},{key:"destroy",value:function(){this.dynamicProperties=null,this.dynamicBuffer.destroy(),this.dynamicBuffer=null,this.dynamicData=null,this.dynamicDataUint32=null,this.staticProperties=null,this.staticBuffer.destroy(),this.staticBuffer=null,this.staticData=null,this.staticDataUint32=null}}]),t}(),h=function(t){function o(t){e(this,o);var i=a(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,t));return i.shader=null,i.indexBuffer=null,i.properties=null,i.tempMatrix=new Tiny.Matrix,i.CONTEXT_UID=0,i}return n(o,t),i(o,[{key:"onContextChange",value:function(){var t=this.renderer.gl;this.CONTEXT_UID=this.renderer.CONTEXT_UID,this.shader=new s(t),this.properties=[{attribute:this.shader.attributes.aVertexPosition,size:2,uploadFunction:this.uploadVertices,offset:0},{attribute:this.shader.attributes.aPositionCoord,size:2,uploadFunction:this.uploadPosition,offset:0},{attribute:this.shader.attributes.aRotation,size:1,uploadFunction:this.uploadRotation,offset:0},{attribute:this.shader.attributes.aTextureCoord,size:2,uploadFunction:this.uploadUvs,offset:0},{attribute:this.shader.attributes.aColor,size:1,unsignedByte:!0,uploadFunction:this.uploadTint,offset:0}]}},{key:"start",value:function(){this.renderer.bindShader(this.shader)}},{key:"render",value:function(t){var e=t.children,i=t._maxSize,r=t._batchSize,n=this.renderer,a=e.length;if(0!==a){a>i&&(a=i);var o=t._glBuffers[n.CONTEXT_UID];o||(o=t._glBuffers[n.CONTEXT_UID]=this.generateBuffers(t));var s=e[0]._texture.baseTexture;this.renderer.setBlendMode(Tiny.correctBlendMode(t.blendMode,s.premultipliedAlpha));var u=n.gl,h=t.worldTransform.copy(this.tempMatrix);h.prepend(n._activeRenderTarget.projectionMatrix),this.shader.uniforms.projectionMatrix=h.toArray(!0),this.shader.uniforms.uColor=Tiny.premultiplyRgba(t.tintRgb,t.worldAlpha,this.shader.uniforms.uColor,s.premultipliedAlpha),this.shader.uniforms.uSampler=n.bindTexture(s);for(var l=!1,d=0,f=0;d<a;d+=r,f+=1){var c=a-d;if(c>r&&(c=r),f>=o.length){if(!t.autoResize)break;o.push(this._generateOneMoreBuffer(t))}var p=o[f];p.uploadDynamic(e,d,c);var y=t._bufferUpdateIDs[f]||0;(l=l||p._updateID<y)&&(p._updateID=t._updateID,p.uploadStatic(e,d,c)),n.bindVao(p.vao),p.vao.draw(u.TRIANGLES,6*c)}}}},{key:"generateBuffers",value:function(t){for(var e=this.renderer.gl,i=[],r=t._maxSize,n=t._batchSize,a=t._properties,o=0;o<r;o+=n)i.push(new u(e,this.properties,a,n));return i}},{key:"_generateOneMoreBuffer",value:function(t){var e=this.renderer.gl,i=t._batchSize,r=t._properties;return new u(e,this.properties,r,i)}},{key:"uploadVertices",value:function(t,e,i,r,n,a){for(var o=0,s=0,u=0,h=0,l=0;l<i;++l){var d=t[e+l],f=d._texture,c=d.scale.x,p=d.scale.y,y=f.trim,v=f.orig;y?(o=(s=y.x-d.anchor.x*v.width)+y.width,u=(h=y.y-d.anchor.y*v.height)+y.height):(o=v.width*(1-d.anchor.x),s=v.width*-d.anchor.x,u=v.height*(1-d.anchor.y),h=v.height*-d.anchor.y),r[a]=s*c,r[a+1]=h*p,r[a+n]=o*c,r[a+n+1]=h*p,r[a+2*n]=o*c,r[a+2*n+1]=u*p,r[a+3*n]=s*c,r[a+3*n+1]=u*p,a+=4*n}}},{key:"uploadPosition",value:function(t,e,i,r,n,a){for(var o=0;o<i;o++){var s=t[e+o].position;r[a]=s.x,r[a+1]=s.y,r[a+n]=s.x,r[a+n+1]=s.y,r[a+2*n]=s.x,r[a+2*n+1]=s.y,r[a+3*n]=s.x,r[a+3*n+1]=s.y,a+=4*n}}},{key:"uploadRotation",value:function(t,e,i,r,n,a){for(var o=0;o<i;o++){var s=t[e+o].rotation;r[a]=s,r[a+n]=s,r[a+2*n]=s,r[a+3*n]=s,a+=4*n}}},{key:"uploadUvs",value:function(t,e,i,r,n,a){for(var o=0;o<i;++o){var s=t[e+o]._texture._uvs;s?(r[a]=s.x0,r[a+1]=s.y0,r[a+n]=s.x1,r[a+n+1]=s.y1,r[a+2*n]=s.x2,r[a+2*n+1]=s.y2,r[a+3*n]=s.x3,r[a+3*n+1]=s.y3,a+=4*n):(r[a]=0,r[a+1]=0,r[a+n]=0,r[a+n+1]=0,r[a+2*n]=0,r[a+2*n+1]=0,r[a+3*n]=0,r[a+3*n+1]=0,a+=4*n)}}},{key:"uploadTint",value:function(t,e,i,r,n,a){for(var o=0;o<i;++o){var s=t[e+o],u=s._texture.baseTexture.premultipliedAlpha,h=s.alpha,l=h<1&&u?Tiny.premultiplyTint(s._tintRGB,h):s._tintRGB+(255*h<<24);r[a]=l,r[a+n]=l,r[a+2*n]=l,r[a+3*n]=l,a+=4*n}}},{key:"destroy",value:function(){this.renderer.gl&&this.renderer.gl.deleteBuffer(this.indexBuffer),r(o.prototype.__proto__||Object.getPrototypeOf(o.prototype),"destroy",this).call(this),this.shader.destroy(),this.indices=null,this.tempMatrix=null}}]),o}(Tiny.ObjectRenderer);Tiny.WebGLRenderer.registerPlugin("particle",h),t.ParticleContainer=o,t.ParticleRenderer=h,Object.defineProperty(t,"__esModule",{value:!0})});
