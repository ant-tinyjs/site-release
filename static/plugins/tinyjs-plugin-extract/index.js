/*!
 * Name: tinyjs-plugin-extract
 * Description: 画布扩展，获取画布的：Image 对象、base64 格式的图片、像素值等等
 * Author: yiiqii
 * Version: v1.4.0
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e.Tiny=e.Tiny||{},e.Tiny.extract={}))}(this,function(e){"use strict";var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),n=new Tiny.Rectangle,a=function(){function e(r){t(this,e),this.renderer=r,r.extract=this}return r(e,[{key:"image",value:function(e){var t=new Image;return t.src=this.base64(e),t}},{key:"base64",value:function(e){return this.canvas(e).toDataURL()}},{key:"canvas",value:function(e,t,r){if(!t&&!r)return this._canvas(e);var n=this.renderer,a=n.resolution,i=n.generateTexture(e,void 0,a,t),o=this._canvas(i);if(r){for(var s=t||i.frame,d=o.getContext("2d").getImageData(0,0,s.width*a,s.height*a),u=new Tiny.CanvasRenderTarget(s.width*a,s.height*a,1),h=0,c=d.data.length/4;h<c;h++)0===d.data[4*h+3]&&(d.data[4*h]=(16711680&r)>>16,d.data[4*h+1]=(65280&r)>>8,d.data[4*h+2]=255&r,d.data[4*h+3]=255);u.context.putImageData(d,0,0),o=u.canvas}return o}},{key:"_canvas",value:function(e){var t=this.renderer,r=void 0,a=void 0,i=void 0,o=!1,s=void 0,d=!1;e&&(e instanceof Tiny.RenderTexture?s=e:(s=this.renderer.generateTexture(e),d=!0)),s?(a=(r=s.baseTexture._glRenderTargets[this.renderer.CONTEXT_UID]).resolution,i=s.frame,o=!1):(a=(r=this.renderer.rootRenderTarget).resolution,o=!0,(i=n).width=r.size.width,i.height=r.size.height);var u=Math.floor(i.width*a+1e-4),h=Math.floor(i.height*a+1e-4),c=new Tiny.CanvasRenderTarget(u,h,1);if(r){t.bindRenderTarget(r);var v=new Uint8Array(4*u*h),g=t.gl;g.readPixels(i.x*a,i.y*a,u,h,g.RGBA,g.UNSIGNED_BYTE,v);var l=c.context.getImageData(0,0,u,h);l.data.set(v),c.context.putImageData(l,0,0),o&&(c.context.scale(1,-1),c.context.drawImage(c.canvas,0,-h))}return d&&s.destroy(!0),c.canvas}},{key:"pixels",value:function(e){var t=this.renderer,r=void 0,a=void 0,i=void 0,o=void 0,s=!1;e&&(e instanceof Tiny.RenderTexture?o=e:(o=this.renderer.generateTexture(e),s=!0)),o?(a=(r=o.baseTexture._glRenderTargets[this.renderer.CONTEXT_UID]).resolution,i=o.frame):(a=(r=this.renderer.rootRenderTarget).resolution,(i=n).width=r.size.width,i.height=r.size.height);var d=i.width*a,u=i.height*a,h=new Uint8Array(4*d*u);if(r){t.bindRenderTarget(r);var c=t.gl;c.readPixels(i.x*a,i.y*a,d,u,c.RGBA,c.UNSIGNED_BYTE,h)}return s&&o.destroy(!0),h}},{key:"destroy",value:function(){this.renderer.extract=null,this.renderer=null}}]),e}();Tiny.WebGLRenderer.registerPlugin("extract",a);var i=new Tiny.Rectangle,o=function(){function e(r){t(this,e),this.renderer=r,r.extract=this}return r(e,[{key:"image",value:function(e){var t=new Image;return t.src=this.base64(e),t}},{key:"base64",value:function(e){return this.canvas(e).toDataURL()}},{key:"canvas",value:function(e,t,r){if(!t&&!r)return this._canvas(e);var n=this.renderer,a=n.resolution,i=n.width,o=n.height,s=new Tiny.Rectangle(0,0,i/a,o/a),d=n.generateTexture(e,void 0,a,s),u=this._canvas(d),h=t||d.frame,c=u.getContext("2d").getImageData(h.x*a,h.y*a,h.width*a,h.height*a),v=new Tiny.CanvasRenderTarget(h.width*a,h.height*a,1);if(r)for(var g=0,l=c.data.length/4;g<l;g++)0===c.data[4*g+3]&&(c.data[4*g]=(16711680&r)>>16,c.data[4*g+1]=(65280&r)>>8,c.data[4*g+2]=255&r,c.data[4*g+3]=255);return v.context.putImageData(c,0,0),u=v.canvas}},{key:"_canvas",value:function(e){var t=this.renderer,r=void 0,n=void 0,a=void 0,o=void 0;e&&(o=e instanceof Tiny.RenderTexture?e:t.generateTexture(e)),o?(r=o.baseTexture._canvasRenderTarget.context,n=o.baseTexture._canvasRenderTarget.resolution,a=o.frame):(r=t.rootContext,n=t.resolution,(a=i).width=this.renderer.width,a.height=this.renderer.height);var s=Math.floor(a.width*n+1e-4),d=Math.floor(a.height*n+1e-4),u=new Tiny.CanvasRenderTarget(s,d,1),h=r.getImageData(a.x*n,a.y*n,s,d);return u.context.putImageData(h,0,0),u.canvas}},{key:"pixels",value:function(e){var t=this.renderer,r=void 0,n=void 0,a=void 0,o=void 0;return e&&(o=e instanceof Tiny.RenderTexture?e:t.generateTexture(e)),o?(r=o.baseTexture._canvasRenderTarget.context,n=o.baseTexture._canvasRenderTarget.resolution,a=o.frame):(r=t.rootContext,(a=i).width=t.width,a.height=t.height),r.getImageData(0,0,a.width*n,a.height*n).data}},{key:"destroy",value:function(){this.renderer.extract=null,this.renderer=null}}]),e}();Tiny.CanvasRenderer.registerPlugin("extract",o),e.webgl=a,e.canvas=o,e.scale=function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:16777215,a=e.width,i=e.height,o=Math.min(t/a,r/i),s=(t/o-a)/2,d=(r/o-i)/2,u=Tiny.isNumber(n)?Tiny.hex2string(n):n,h=new Tiny.CanvasRenderTarget(t,r,1);return h.context.scale(o,o),h.context.fillStyle=u,h.context.fillRect(0,0,t/o,r/o),h.context.drawImage(e,s,d),h.canvas},Object.defineProperty(e,"__esModule",{value:!0})});
