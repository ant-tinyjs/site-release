/*!
 * Name: tinyjs-plugin-bitmap-text
 * Description: Create a line or multiple lines of text using bitmap font
 * Author: fangjun.yfj
 * Version: v0.1.0
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t.Tiny=t.Tiny||{},t.Tiny.BitmapText=e())}(this,function(){"use strict";var t=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,e=function(e){return t.exec(e).slice(1)};var n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},a=function(t){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,e);var a=r(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a._textWidth=0,a._textHeight=0,a._glyphs=[],a._font={tint:void 0!==i.tint?i.tint:16777215,align:i.align||"left",name:null,size:0},a.font=i.font,a._text=t,a._maxWidth=0,a._maxLineHeight=0,a._letterSpacing=0,a._anchor=new Tiny.ObservablePoint(function(){a.dirty=!0},a,0,0),a.dirty=!1,a.updateText(),a}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(e,Tiny.Container),i(e,[{key:"updateText",value:function(){for(var t=e.fonts[this._font.name],n=this._font.size/t.size,i=new Tiny.Point,r=[],a=[],s=this.text.replace(/(?:\r\n|\r)/g,"\n"),o=s.length,h=this._maxWidth*t.size/this._font.size,u=null,l=0,f=0,g=0,c=-1,y=0,p=0,d=0,x=0;x<o;x++){var _=s.charCodeAt(x),m=s.charAt(x);if(/(?:\s)/.test(m)&&(c=x,y=l),"\r"!==m&&"\n"!==m){var v=t.chars[_];v&&(u&&v.kerning[u]&&(i.x+=v.kerning[u]),r.push({texture:v.texture,line:g,charCode:_,position:new Tiny.Point(i.x+v.xOffset+this._letterSpacing/2,i.y+v.yOffset)}),i.x+=v.xAdvance+this._letterSpacing,l=i.x,d=Math.max(d,v.yOffset+v.texture.height),u=_,-1!==c&&h>0&&i.x>h&&(++p,Tiny.removeItems(r,1+c-p,1+x-c),x=c,c=-1,a.push(y),f=Math.max(f,y),g++,i.x=0,i.y+=t.lineHeight,u=null))}else a.push(l),f=Math.max(f,l),++g,++p,i.x=0,i.y+=t.lineHeight,u=null}var b=s.charAt(s.length-1);"\r"!==b&&"\n"!==b&&(/(?:\s)/.test(b)&&(l=y),a.push(l),f=Math.max(f,l));for(var T=[],A=0;A<=g;A++){var O=0;"right"===this._font.align?O=f-a[A]:"center"===this._font.align&&(O=(f-a[A])/2),T.push(O)}for(var k=r.length,w=this.tint,I=0;I<k;I++){var E=this._glyphs[I];E?E.texture=r[I].texture:(E=new Tiny.Sprite(r[I].texture),this._glyphs.push(E)),E.position.x=(r[I].position.x+T[r[I].line])*n,E.position.y=r[I].position.y*n,E.scale.x=E.scale.y=n,E.tint=w,E.parent||this.addChild(E)}for(var H=k;H<this._glyphs.length;++H)this.removeChild(this._glyphs[H]);if(this._textWidth=f*n,this._textHeight=(i.y+t.lineHeight)*n,0!==this.anchor.x||0!==this.anchor.y)for(var j=0;j<k;j++)this._glyphs[j].x-=this._textWidth*this.anchor.x,this._glyphs[j].y-=this._textHeight*this.anchor.y;this._maxLineHeight=d*n}},{key:"updateTransform",value:function(){this.validate(),this.containerUpdateTransform()}},{key:"getLocalBounds",value:function(){return this.validate(),function t(e,n,i){null===e&&(e=Function.prototype);var r=Object.getOwnPropertyDescriptor(e,n);if(void 0===r){var a=Object.getPrototypeOf(e);return null===a?void 0:t(a,n,i)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(i):void 0}(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"getLocalBounds",this).call(this)}},{key:"validate",value:function(){this.dirty&&(this.updateText(),this.dirty=!1)}},{key:"tint",get:function(){return this._font.tint},set:function(t){this._font.tint="number"==typeof t&&t>=0?t:16777215,this.dirty=!0}},{key:"align",get:function(){return this._font.align},set:function(t){this._font.align=t||"left",this.dirty=!0}},{key:"anchor",get:function(){return this._anchor},set:function(t){"number"==typeof t?this._anchor.set(t):this._anchor.copy(t)}},{key:"font",get:function(){return this._font},set:function(t){t&&("string"==typeof t?(t=t.split(" "),this._font.name=1===t.length?t[0]:t.slice(1).join(" "),this._font.size=t.length>=2?parseInt(t[0],10):e.fonts[this._font.name].size):(this._font.name=t.name,this._font.size="number"==typeof t.size?t.size:parseInt(t.size,10)),this.dirty=!0)}},{key:"text",get:function(){return this._text},set:function(t){t=t.toString()||" ",this._text!==t&&(this._text=t,this.dirty=!0)}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(t){this._maxWidth!==t&&(this._maxWidth=t,this.dirty=!0)}},{key:"maxLineHeight",get:function(){return this.validate(),this._maxLineHeight}},{key:"textWidth",get:function(){return this.validate(),this._textWidth}},{key:"letterSpacing",get:function(){return this._letterSpacing},set:function(t){this._letterSpacing!==t&&(this._letterSpacing=t,this.dirty=!0)}},{key:"textHeight",get:function(){return this.validate(),this._textHeight}}],[{key:"registerFont",value:function(t,n){var i={},r=t.getElementsByTagName("info")[0],a=t.getElementsByTagName("common")[0],s=t.getElementsByTagName("page"),o=Tiny.getResolutionOfUrl(s[0].getAttribute("file"),Tiny.settings.RESOLUTION),h={};i.font=r.getAttribute("face"),i.size=parseInt(r.getAttribute("size"),10),i.lineHeight=parseInt(a.getAttribute("lineHeight"),10)/o,i.chars={},n instanceof Tiny.Texture&&(n=[n]);for(var u=0;u<s.length;u++){var l=s[u].getAttribute("id"),f=s[u].getAttribute("file");h[l]=n instanceof Array?n[u]:n[f]}for(var g=t.getElementsByTagName("char"),c=0;c<g.length;c++){var y=g[c],p=parseInt(y.getAttribute("id"),10),d=y.getAttribute("page")||0,x=new Tiny.Rectangle(parseInt(y.getAttribute("x"),10)/o+h[d].frame.x/o,parseInt(y.getAttribute("y"),10)/o+h[d].frame.y/o,parseInt(y.getAttribute("width"),10)/o,parseInt(y.getAttribute("height"),10)/o);i.chars[p]={xOffset:parseInt(y.getAttribute("xoffset"),10)/o,yOffset:parseInt(y.getAttribute("yoffset"),10)/o,xAdvance:parseInt(y.getAttribute("xadvance"),10)/o,kerning:{},texture:new Tiny.Texture(h[d].baseTexture,x),page:d}}for(var _=t.getElementsByTagName("kerning"),m=0;m<_.length;m++){var v=_[m],b=parseInt(v.getAttribute("first"),10)/o,T=parseInt(v.getAttribute("second"),10)/o,A=parseInt(v.getAttribute("amount"),10)/o;i.chars[T]&&(i.chars[T].kerning[b]=A)}return e.fonts[i.font]=i,i}}]),e}();a.fonts={};var s=Tiny.loaders.Resource;var o=Tiny.loaders.Loader;return o.addTinyMiddleware(function(){return function(t,n){if(t.data&&t.type===s.TYPE.XML)if(0!==t.data.getElementsByTagName("page").length&&0!==t.data.getElementsByTagName("info").length&&null!==t.data.getElementsByTagName("info")[0].getAttribute("face")){var i,r,o,h,u=t.isDataUrl?"":(i=t.url,r=e(i),o=r[0],h=r[1],o||h?(h&&(h=h.substr(0,h.length-1)),o+h):".");t.isDataUrl&&("."===u&&(u=""),this.baseUrl&&u&&"/"===this.baseUrl.charAt(this.baseUrl.length-1)&&(u+="/")),(u=u.replace(this.baseUrl,""))&&"/"!==u.charAt(u.length-1)&&(u+="/");for(var l=t.data.getElementsByTagName("page"),f={},g=function(e){f[e.metadata.pageFile]=e.texture,Object.keys(f).length===l.length&&(function(t,e){t.bitmapFont=a.registerFont(t.data,e)}(t,f),n())},c=0;c<l.length;++c){var y=l[c].getAttribute("file"),p=u+y,d=!1;for(var x in this.resources){var _=this.resources[x];if(_.url===p){_.metadata.pageFile=y,_.texture?g(_):_.onAfterMiddleware.add(g),d=!0;break}}if(!d){var m={crossOrigin:t.crossOrigin,loadType:s.LOAD_TYPE.IMAGE,metadata:Object.assign({pageFile:y},t.metadata.imageMetadata),parentResource:t};this.add(p,m,g)}}}else n();else n()}}),Tiny.Loader&&(Tiny.Loader=o?new o:null),a});
