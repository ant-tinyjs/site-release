/*!
 * Name: tinyjs-plugin-accessibility
 * Description: Renderer plugin for interaction accessibility for end-users with physical impairments which require screen-renders
 * Author: yiiqii
 * Version: v0.0.3
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e.Tiny=e.Tiny||{},e.Tiny.accessibility={}))}(this,function(e){"use strict";var t={accessible:{type:"label",hint:null,attr:{}},_accessible:{active:!1,div:null,hitArea:null}},i=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},s=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),n=100,r=0,l=0,a=2,c=function(){function e(t){i(this,e);var s=document.createElement("div");s.style.width=n+"px",s.style.height=n+"px",s.style.position="absolute",s.style.top=r+"px",s.style.left=l+"px",s.style.zIndex=a,s.style.pointerEvents="none",this.div=s,this.dpi=t.resolution,this.pool=[],this.renderId=0,this.debug=!1,this.eventType="pointerdown",this.renderer=t,this.children=[],this.isActive=!1,this._sx=0,this._sy=0}return s(e,[{key:"activate",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.debug,i=void 0!==t&&t,s=e.cell,n=void 0===s?null:s,r=e.eventType;this.debug=i,n&&(this.div=n),r&&(this.eventType=r),this.isActive||(this.isActive=!0,this.updateDiv(),this.renderer.on("postrender",this.update,this),this.renderer.view.parentNode&&this.renderer.view.parentNode.appendChild(this.div))}},{key:"deactivate",value:function(){this.isActive&&(this.isActive=!1,this.renderer.off("postrender",this.update),this.div.parentNode&&this.div.parentNode.removeChild(this.div))}},{key:"updateAccessibleObjects",value:function(e){if(e.visible&&e.renderable){e.accessible&&(e._accessible&&e._accessible.active||this.addChild(e),e.renderId=this.renderId);for(var t=e.children,i=0;i<t.length;i++)this.updateAccessibleObjects(t[i])}}},{key:"updateDiv",value:function(){var e=this.renderer,t=e.view,i=e.width,s=e.height,n=t.getBoundingClientRect(),r=n.width,l=n.height,a=n.left,c=n.top,d=this.dpi,h=this.div;this._sx=r/i,this._sy=l/s,h.style.left=a+"px",h.style.top=c+"px",h.style.width=i/d+"px",h.style.height=s/d+"px"}},{key:"update",value:function(){var e=this.renderer,t=e.renderingToScreen,i=e._lastObjectRendered;if(t){this.updateAccessibleObjects(i);for(var s=0;s<this.children.length;s++){var n=this.children[s];if(n.renderId!==this.renderId)n._accessible.active=!1,Tiny.removeItems(this.children,s,1),this.div.removeChild(n._accessible.div),this.pool.push(n._accessible.div),n._accessible.div=null,s--;else{var r=n._accessible,l=n.hitArea,a=n.worldTransform,c=r.div,d=this._sx,h=this._sy,o=this.dpi;l?n._accessible.hitArea!==l&&(c.style.left=(a.tx+l.x*a.a)*d+"px",c.style.top=(a.ty+l.y*a.d)*h+"px",c.style.width=l.width*a.a*d+"px",c.style.height=l.height*a.d*h+"px",n._accessible.hitArea=l):(l=n.getBounds(),this.capHitArea(l),c.style.left=l.x*d*o+"px",c.style.top=l.y*h*o+"px",c.style.width=l.width*d*o+"px",c.style.height=l.height*h*o+"px",n._accessible.hitArea=l);var u=n.accessible,v=u.attr,p=u.hint;if(v)for(var y=c.attributes,b=y.length-1;b>=0;b--){var f=y[b],g=f.name,x=f.value,A=v[g];"style"!==g&&A&&x!==A+""&&(console.log(g,x),c.setAttribute(g,A))}p&&c.getAttribute("aria-label")!==p&&(console.log(p),c.setAttribute("aria-label",p))}}this.renderId++}}},{key:"capHitArea",value:function(e){e.x<0&&(e.width+=e.x,e.x=0),e.y<0&&(e.height+=e.y,e.y=0),e.x+e.width>this.renderer.width&&(e.width=this.renderer.width-e.x),e.y+e.height>this.renderer.height&&(e.height=this.renderer.height-e.y)}},{key:"addChild",value:function(e){e.accessible=Object.assign({},t.accessible,e.accessible||{}),e.interactive&&(e.accessible.type="button");var i=e.accessible,s=i.type,r=i.hint,l=i.attr,c=this.pool.pop();if(!c){switch(s){case"label":(c=document.createElement("div")).setAttribute("role","text");break;default:(c=document.createElement("button")).style.borderStyle="none"}c.style.width=n+"px",c.style.height=n+"px",c.style.backgroundColor=this.debug?"rgba(255,0,0,0.5)":"transparent",c.style.position="absolute",c.style.zIndex=a,c.style.pointerEvents="auto",c.addEventListener("click",this._onClick.bind(this))}var d=l.title;for(var h in r&&(d=r),d&&c.setAttribute("aria-label",d),l)l.hasOwnProperty(h)&&c.setAttribute(h,l[h]);e._accessible={active:!0,div:c},c.displayObject=e,this.children.push(e),this.div.appendChild(c)}},{key:"_onClick",value:function(e){var t=this.renderer.plugins.interaction,i=this.eventType;Tiny.isArray(i)||(i=[i]),i.forEach(function(i){t.dispatchEvent(e.target.displayObject,i,t.eventData)})}},{key:"destroy",value:function(){this.div=null;for(var e=0;e<this.children.length;e++)this.children[e].div=null;this.pool=null,this.children=null,this.renderer=null}}]),e}();Tiny.WebGLRenderer.registerPlugin("accessibility",c),Tiny.CanvasRenderer.registerPlugin("accessibility",c),e.accessibleTarget=t,e.AccessibilityManager=c,e.autoActivate=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.acReader)return e.renderer.plugins.accessibility.activate(t);if(void 0===i.acReader)if(Tiny.isMobile.android.device){var s=document.createElement("button");s.setAttribute("aria-live","assertive"),s.setAttribute("role","alert"),s.innerText=i.tip||"请点按两次开启无障碍模式",e.view.appendChild(s),s.focus(),s.addEventListener("click",function(){e.renderer.plugins.accessibility.activate(t),Tiny.isFunction(i.onActivate)&&i.onActivate(s)})}else i.forceActivate&&e.renderer.plugins.accessibility.activate(t)},Object.defineProperty(e,"__esModule",{value:!0})});
