/*!
 * Name: tinyjs-plugin-tiling
 * Description: A fast way of rendering a tiling image
 * Author: yiiqii
 * Version: v0.1.1
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t.Tiny=t.Tiny||{},t.Tiny.tiling={}))}(this,function(t){"use strict";var e=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),i=function t(e,r,i){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,r);if(void 0===n){var o=Object.getPrototypeOf(e);return null===o?void 0:t(o,r,i)}if("value"in n)return n.value;var a=n.get;return void 0!==a?a.call(i):void 0},n=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},o=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},a=new Tiny.Point,s=function(t){function s(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:100;e(this,s);var n=o(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,t));return n.tileTransform=new Tiny.TransformStatic,n._width=r,n._height=i,n._canvasPattern=null,n.uvTransform=t.transform||new Tiny.TextureTransform(t),n.pluginName="tilingSprite",n.uvRespectAnchor=!1,n}return n(s,t),r(s,[{key:"_onTextureUpdate",value:function(){this.uvTransform&&(this.uvTransform.texture=this._texture),this.cachedTint=16777215}},{key:"_renderWebGL",value:function(t){var e=this._texture;e&&e.valid&&(this.tileTransform.updateLocalTransform(),this.uvTransform.update(),t.setObjectRenderer(t.plugins[this.pluginName]),t.plugins[this.pluginName].render(this))}},{key:"_renderCanvas",value:function(t){var e=this._texture;if(e.baseTexture.hasLoaded){var r=t.context,i=this.worldTransform,n=t.resolution,o=2===e.rotate,a=e.baseTexture,s=a.resolution,h=this.tilePosition.x/this.tileScale.x%e.orig.width*s,u=this.tilePosition.y/this.tileScale.y%e.orig.height*s;if(this._textureID!==this._texture._updateID||this.cachedTint!==this.tint){this._textureID=this._texture._updateID;var l=new Tiny.CanvasRenderTarget(e.orig.width,e.orig.height,s);if(16777215!==this.tint)this.tintedTexture=Tiny.CanvasTinter.getTintedTexture(this,this.tint),l.context.drawImage(this.tintedTexture,0,0);else{var c=e._frame.x*s,d=e._frame.y*s,f=e._frame.width*s,m=e._frame.height*s,p=(e.trim?e.trim.width:e.orig.width)*s,y=(e.trim?e.trim.height:e.orig.height)*s,v=(e.trim?e.trim.x:0)*s,_=(e.trim?e.trim.y:0)*s;o?(l.context.rotate(-Math.PI/2),l.context.translate(-y,0),l.context.drawImage(a.source,c,d,f,m,-_,v,y,p)):l.context.drawImage(a.source,c,d,f,m,v,_,p,y)}this.cachedTint=this.tint,this._canvasPattern=l.context.createPattern(l.canvas,"repeat")}r.globalAlpha=this.worldAlpha,r.setTransform(i.a*n,i.b*n,i.c*n,i.d*n,i.tx*n,i.ty*n),t.setBlendMode(this.blendMode),r.fillStyle=this._canvasPattern,r.scale(this.tileScale.x/s,this.tileScale.y/s);var T=this.anchor.x*-this._width*s,g=this.anchor.y*-this._height*s;this.uvRespectAnchor?(r.translate(h,u),r.fillRect(-h+T,-u+g,this._width/this.tileScale.x*s,this._height/this.tileScale.y*s)):(r.translate(h+T,u+g),r.fillRect(-h,-u,this._width/this.tileScale.x*s,this._height/this.tileScale.y*s))}}},{key:"_calculateBounds",value:function(){var t=this._width*-this._anchor._x,e=this._height*-this._anchor._y,r=this._width*(1-this._anchor._x),i=this._height*(1-this._anchor._y);this._bounds.addFrame(this.transform,t,e,r,i)}},{key:"getLocalBounds",value:function(t){return 0===this.children.length?(this._bounds.minX=this._width*-this._anchor._x,this._bounds.minY=this._height*-this._anchor._y,this._bounds.maxX=this._width*(1-this._anchor._x),this._bounds.maxY=this._height*(1-this._anchor._y),t||(this._localBoundsRect||(this._localBoundsRect=new Tiny.Rectangle),t=this._localBoundsRect),this._bounds.getRectangle(t)):i(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"getLocalBounds",this).call(this,t)}},{key:"containsPoint",value:function(t){this.worldTransform.applyInverse(t,a);var e=this._width,r=this._height,i=-e*this.anchor._x;if(a.x>=i&&a.x<i+e){var n=-r*this.anchor._y;if(a.y>=n&&a.y<n+r)return!0}return!1}},{key:"destroy",value:function(t){i(s.prototype.__proto__||Object.getPrototypeOf(s.prototype),"destroy",this).call(this,t),this.tileTransform=null,this.uvTransform=null}},{key:"clampMargin",get:function(){return this.uvTransform.clampMargin},set:function(t){this.uvTransform.clampMargin=t,this.uvTransform.update(!0)}},{key:"tileScale",get:function(){return this.tileTransform.scale},set:function(t){this.tileTransform.scale.copy(t)}},{key:"tilePosition",get:function(){return this.tileTransform.position},set:function(t){this.tileTransform.position.copy(t)}},{key:"width",get:function(){return this._width},set:function(t){this._width=t}},{key:"height",get:function(){return this._height},set:function(t){this._height=t}}],[{key:"from",value:function(t,e,r){return new s(Tiny.Texture.from(t),e,r)}},{key:"fromFrame",value:function(t,e,r){var i=Tiny.TextureCache[t];if(!i)throw new Error('The frameId "'+t+'" does not exist in the texture cache '+this);return new s(i,e,r)}},{key:"fromImage",value:function(t,e,r,i,n){return new s(Tiny.Texture.fromImage(t,i,n),e,r)}}]),s}(Tiny.Sprite),h=new Tiny.Matrix,u="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\nuniform mat3 uMapCoord;\nuniform vec4 uClampFrame;\nuniform vec2 uClampOffset;\n\nvoid main(void){\n  vec2 coord = mod(vTextureCoord - uClampOffset, vec2(1.0, 1.0)) + uClampOffset;\n  coord = (uMapCoord * vec3(coord, 1.0)).xy;\n  coord = clamp(coord, uClampFrame.xy, uClampFrame.zw);\n\n  vec4 sample = texture2D(uSampler, coord);\n  gl_FragColor = sample * uColor;\n}",l="attribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\n\nuniform mat3 projectionMatrix;\nuniform mat3 translationMatrix;\nuniform mat3 uTransform;\n\nvarying vec2 vTextureCoord;\n\nvoid main(void) {\n  gl_Position = vec4((projectionMatrix * translationMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n  vTextureCoord = (uTransform * vec3(aTextureCoord, 1.0)).xy;\n}",c="varying vec2 vTextureCoord;\n\nuniform sampler2D uSampler;\nuniform vec4 uColor;\n\nvoid main(void)\n{\n  vec4 sample = texture2D(uSampler, vTextureCoord);\n  gl_FragColor = sample * uColor;\n}",d=function(t){function i(t){e(this,i);var r=o(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t));return r.shader=null,r.simpleShader=null,r.quad=null,r}return n(i,t),r(i,[{key:"onContextChange",value:function(){var t=this.renderer.gl;this.shader=new Tiny.Shader(t,l,u),this.simpleShader=new Tiny.Shader(t,l,c),this.renderer.bindVao(null),this.quad=new Tiny.Quad(t,this.renderer.state.attribState),this.quad.initVao(this.shader)}},{key:"render",value:function(t){var e=this.renderer,r=this.quad;e.bindVao(r.vao);var i=r.vertices;i[0]=i[6]=t._width*-t.anchor.x,i[1]=i[3]=t._height*-t.anchor.y,i[2]=i[4]=t._width*(1-t.anchor.x),i[5]=i[7]=t._height*(1-t.anchor.y),t.uvRespectAnchor&&((i=r.uvs)[0]=i[6]=-t.anchor.x,i[1]=i[3]=-t.anchor.y,i[2]=i[4]=1-t.anchor.x,i[5]=i[7]=1-t.anchor.y),r.upload();var n=t._texture,o=n.baseTexture,a=t.tileTransform.localTransform,s=t.uvTransform,u=o.isPowerOfTwo&&n.frame.width===o.width&&n.frame.height===o.height;u&&(o._glTextures[e.CONTEXT_UID]?u=o.wrapMode!==Tiny.WRAP_MODES.CLAMP:o.wrapMode===Tiny.WRAP_MODES.CLAMP&&(o.wrapMode=Tiny.WRAP_MODES.REPEAT));var l=u?this.simpleShader:this.shader;e.bindShader(l);var c=n.width,d=n.height,f=t._width,m=t._height;h.set(a.a*c/f,a.b*c/m,a.c*d/f,a.d*d/m,a.tx/f,a.ty/m),h.invert(),u?h.prepend(s.mapCoord):(l.uniforms.uMapCoord=s.mapCoord.toArray(!0),l.uniforms.uClampFrame=s.uClampFrame,l.uniforms.uClampOffset=s.uClampOffset),l.uniforms.uTransform=h.toArray(!0),l.uniforms.uColor=Tiny.premultiplyTintToRgba(t.tint,t.worldAlpha,l.uniforms.uColor,o.premultipliedAlpha),l.uniforms.translationMatrix=t.transform.worldTransform.toArray(!0),l.uniforms.uSampler=e.bindTexture(n),e.setBlendMode(Tiny.correctBlendMode(t.blendMode,o.premultipliedAlpha)),r.vao.draw(this.renderer.gl.TRIANGLES,6,0)}}]),i}(Tiny.ObjectRenderer);Tiny.WebGLRenderer.registerPlugin("tilingSprite",d),t.TilingSprite=s,t.TilingSpriteRenderer=d,Object.defineProperty(t,"__esModule",{value:!0})});
