/*!
 * Name: tinyjs-plugin-audio
 * Description: Tiny.js 音效插件
 * Author: yiiqii
 * Version: v1.2.0
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e.Tiny=e.Tiny||{},e.Tiny.audio={}))}(this,function(e){"use strict";var t=Tiny.loaders.Resource,i=!!window.Audio,o=window.AudioContext||window.webkitAudioContext,r=!0!==window.disableWebAudio&&!!o,n=r||i,u=!1,a=!1,s=!1,d=!1,p=null,c=r?new o:null;if(n){var l=document.createElement("audio");u=""!==l.canPlayType("audio/mpeg;"),a=""!==l.canPlayType('audio/ogg; codecs="vorbis"'),s=""!==l.canPlayType("audio/wav"),d=""!==l.canPlayType('audio/mp4; codecs="mp4a.40.5"'),u&&h("mp3"),a&&h("ogg"),s&&h("wav"),d&&h("m4a"),r&&(p=function(){return c.createGain?c.createGain():c.createGainNode()})}function h(e){r?(delete t._loadTypeMap.mp3,delete t._loadTypeMap.ogg,delete t._loadTypeMap.wav,t._xhrTypeMap.mp3=t.XHR_RESPONSE_TYPE.BUFFER,t._xhrTypeMap.ogg=t.XHR_RESPONSE_TYPE.BUFFER,t._xhrTypeMap.wav=t.XHR_RESPONSE_TYPE.BUFFER,t.setExtensionXhrType(e,t.XHR_RESPONSE_TYPE.BUFFER)):t.setExtensionLoadType(e,t.LOAD_TYPE.AUDIO)}var y={isHTMLAudioSupported:i,webAudioContext:o,isWebAudioSupported:r,isAudioSupported:n,isMp3Supported:u,isOggSupported:a,isWavSupported:s,isM4aSupported:d,globalWebAudioContext:c,createGainNode:p},f=["ogg","mp3"],m={mp3:"audio/mpeg",mp4:"audio/mp4",ogg:'audio/ogg; codecs="vorbis"',m4a:"audio/x-m4a",wav:'audio/wav; codecs="1"'};function v(e){var t=void 0;if(!Tiny.isArray(e)){var i=[];i.push(e),e=i}for(var o=0;o<e.length;o++){var r=g(e[o]);-1!==f.indexOf(r)&&(t=b(r)?e[o]:e[o].replace(/\.[^\.\/\?\\]*(\?.*)?$/,"."+_()))}return t}function g(e){return e.split("?").shift().split(".").pop().toLowerCase()}function b(e){var t=!1;switch(e){case"m4a":t=y.isM4aSupported;break;case"mp3":t=y.isMp3Supported;break;case"ogg":t=y.isOggSupported;break;case"wav":t=y.isWavSupported}return t}function _(){var e=new Audio;return Tiny.detect(f,function(t){return e.canPlayType(m[t])?t:null})}var T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},A=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},S=function(){function e(e,t){for(var i=0;i<t.length;i++){var o=t[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,i,o){return i&&e(t.prototype,i),o&&e(t,o),t}}(),w=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},E=function(e){function t(e,i){A(this,t);var o=w(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return o.manager=i,o.data=e,y.isWebAudioSupported?(o.context=y.globalWebAudioContext,o.gainNode=y.createGainNode()):(o.audio=new window.Audio,o.audio.addEventListener("ended",o._onEnd.bind(o)),o.audio.src=o.data.children[0].src,o.audio.preload="auto",o.audio.load()),o.reset(),o}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,Tiny.EventEmitter),S(t,[{key:"play",value:function(){return this.playing?this:(this.emit("play"),y.isWebAudioSupported?(this.source=this.context.createBufferSource(),this.source.start=this.source.start||this.source.noteOn,this.source.stop=this.source.stop||this.source.noteOff,this.source.loop=this.loop,this.source.onended=this._onEnd.bind(this),this._startTime=this.context.currentTime,this.source.connect(this.gainNode),this.gainNode.connect(this.context.destination),this.source.buffer=this.data,this.source.start(0,this._paused?this._lastPauseTime:0)):this.audio.play(),this.playing=!0,this)}},{key:"stop",value:function(){return this.emit("stop"),y.isWebAudioSupported?(this.source&&this.source.stop(0),this._paused=!1,this._startTime=this.context.currentTime):(this.audio.pause(),this.audio.currentTime=0),this.playing=!1,this._paused=!1,this.reset(),this}},{key:"pause",value:function(){return this.playing?(this.emit("pause"),y.isWebAudioSupported?(this._offsetTime+=this.context.currentTime-this._startTime,this._lastPauseTime=this._offsetTime%this.data.duration,this.source.stop(0)):this.audio.pause(),this.playing=!1,this._paused=!0,this):this}},{key:"reset",value:function(){this._startTime=0,this._lastPauseTime=0,this._offsetTime=0,this.playing=!1,this._paused=!1,y.isWebAudioSupported&&(this.audio=null)}},{key:"remove",value:function(){this.manager.removeAudio(this)}},{key:"_onEnd",value:function(){y.isWebAudioSupported?this._paused||(this.reset(),this.emit("end")):this.loop?(this.audio.currentTime=0,this.audio.play()):(this.reset(),this.emit("end"))}},{key:"loop",get:function(){return this._loop},set:function(e){e!==this._loop&&(this._loop=e,y.isWebAudioSupported&&this.audio&&(this.audio.loop=e))}},{key:"volume",get:function(){return y.isWebAudioSupported?this.gainNode.gain.value:this.audio.volume},set:function(e){this.previousVolume=e,y.isWebAudioSupported?this.gainNode.gain.value=e:this.audio.volume=e}},{key:"muted",get:function(){return y.isWebAudioSupported?this.mute:this.audio.muted},set:function(e){if(y.isWebAudioSupported){if(this.mute=e,!e)return void(this.gainNode.gain.value=this.previousVolume);this.gainNode.gain.value=0}else this.audio.muted=e}}]),t}();E.prototype._loop=!1,E.prototype._paused=!1,E.prototype._startTime=0,E.prototype._lastPauseTime=0,E.prototype._offsetTime=0,E.prototype.previousVolume=1,E.prototype.mute=!1,E.prototype.playing=!1;var P=function(){function e(){A(this,e),this.sounds=[]}return S(e,[{key:"getAudio",value:function(t){var i=new E(e.audios[v(t)||t],this);return this.sounds.push(i),i}},{key:"removeAudio",value:function(e){var t=this.sounds.indexOf(e);-1!==t&&this.sounds.splice(t,1)}},{key:"pause",value:function(e){e=!1!==e,this.sounds.forEach(function(t){if(!e&&t._paused)return t.play(),!0;t.playing&&t.pause()})}},{key:"resume",value:function(){return this.pause(!1)}}]),e}();P.audios={};var x=function(){function e(t,i){A(this,e),y.isWebAudioSupported?(this.analyser=t.context.createAnalyser(),this.analyser.fftSize=i||2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.gainNode.connect(this.analyser)):console.warn("not support web audio api. the data will return empty array or zero.")}return S(e,[{key:"getFrequencyData",value:function(){return y.isWebAudioSupported&&this.analyser.getByteFrequencyData(this.data),this.data||[]}},{key:"getAverageFrequency",value:function(){var e=0,t=this.getFrequencyData();if(y.isWebAudioSupported)for(var i=0;i<t.length;i++)e+=t[i];return e/t.length||0}}]),e}(),O={utils:y,AudioManager:P,AudioAnalyser:x,Audio:E,audioParser:function(){return function(e,t){if(!y.isAudioSupported||!e.data)return t();var i=g(e.url);if(-1===f.indexOf(i)||!b(i))return t();var o=e.name||e.url;if(!y.isWebAudioSupported)return P.audios[o]=e.data,t();y.globalWebAudioContext.decodeAudioData(e.data,function(e){P.audios[o]=e,t()})}},audioUrlParser:v},W=Tiny.loaders.Loader;W.addTinyMiddleware(O.audioParser);var k=W.prototype.add;W.prototype.add=function(e,t,i,o){return"object"===(void 0===e?"undefined":T(e))&&"[object Array]"===Object.prototype.toString.call(e.url)&&(e.url=O.audioUrlParser(e.url)),"[object Array]"===Object.prototype.toString.call(t)&&(t=O.audioUrlParser(t)),Tiny.isArray(e)&&e.forEach(function(t,i){var o=void 0;t.url?(o=O.audioUrlParser(t.url))&&(e[i].url=o):(o=O.audioUrlParser(t))&&(e[i]=o)}),k.call(this,e,t,i,o)},Tiny.Loader&&(Tiny.Loader=W?new W:null);var M=new O.AudioManager;e.com=O,e.manager=M,Object.defineProperty(e,"__esModule",{value:!0})});
